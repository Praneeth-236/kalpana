<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard - CareBridge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <div class="container">
        <h1>Doctor Dashboard</h1>
        <p class="subtitle">Doctor: {{ doctor['name'] }} ({{ doctor['specialization'] }})</p>

        {% if portal_mode %}
        <div class="actions">
            <a class="btn" href="{{ url_for('doctor_portal_dashboard') }}">Refresh</a>
        </div>

        <div class="card">
            <h2>Pending Patient Requests</h2>
            {% for link in pending_links %}
            <p>
                <strong>{{ link['patient_name'] }}</strong> (Patient ID: {{ link['patient_id'] }})
                <a class="btn" href="{{ url_for('doctor_approve_patient', link_id=link['id']) }}">Approve</a>
            </p>
            {% else %}
            <p>No pending requests.</p>
            {% endfor %}
        </div>

        <div class="card">
            <h2>Linked Patients</h2>
            {% for row in patient_rows %}
            {% set p = row['patient'] %}
            <p><strong>Name:</strong> {{ p['name'] }}</p>
            <p><strong>Risk Level:</strong> {{ p['risk_level'] or 'N/A' }}</p>
            <p><strong>Stress Score:</strong> {{ p['stress_score'] if p['stress_score'] is not none else 'N/A' }}</p>
            <p><strong>Energy Score:</strong> {{ p['energy_score'] if p['energy_score'] is not none else 'N/A' }}</p>
            <p><strong>Trend:</strong> {{ p['trend'] or 'N/A' }}</p>
            <p><strong>Last Assessment:</strong> {{ p['last_assessment_at'] or 'N/A' }}</p>
            <p><strong>Patient Summary:</strong> {{ row['summary'] }}</p>
            <a class="btn" href="{{ url_for('doctor_patient_detail', patient_id=p['patient_id']) }}">View Patient</a>
            <a class="btn" href="{{ url_for('doctor_add_prescription', patient_id=p['patient_id']) }}">Add Prescription</a>
            <hr />
            {% else %}
            <p>No approved linked patients yet.</p>
            {% endfor %}
        </div>

        {% else %}

        <div class="actions">
            <a class="btn" href="{{ url_for('doctor_create_questionnaire', doctor_id=doctor['id']) }}">Create Questionnaire</a>
        </div>

        <div class="card">
            <h2>Link Patient</h2>
            <form method="POST" action="{{ url_for('doctor_dashboard', doctor_id=doctor['id']) }}">
                <label>Patient User ID</label>
                <input type="number" name="user_id" min="1" required />
                <button class="btn" type="submit">Link Patient</button>
            </form>
        </div>

        <h2>Linked Patients</h2>
        {% for item in patient_cards %}
        <div class="card">
            <p><strong>Name:</strong> {{ item['patient']['name'] }} (User ID: {{ item['patient']['id'] }})</p>
            <p><strong>Adherence Score:</strong> {{ item['adherence_score'] }}%</p>
            <p><strong>Health Stability Score:</strong> {{ item['health_score'] }}%</p>
            <p><strong>Risk Level:</strong> {{ item['risk'] }}</p>
            <pre class="explanation">{{ item['recommendation_explanation'] }}</pre>
            <a class="btn" href="{{ url_for('doctor_view_answers', doctor_id=doctor['id'], user_id=item['patient']['id']) }}">View Answers</a>
        </div>
        {% else %}
        <div class="card">
            <p>No linked patients yet.</p>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</body>
</html>
