<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Dashboard - CareMatch AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <div class="container">
        <section class="hero">
            <div>
                <h1 class="hero-title">Patient Dashboard</h1>
                <p class="hero-copy">Overview for {{ user['name'] }} with prescriptions, adherence, health trend, and top hospital guidance in one place.</p>
                <div class="hero-badges">
                    <span class="badge">Health Monitoring</span>
                    <span class="badge">Doctor Prescriptions</span>
                    <span class="badge">Adaptive Risk Insights</span>
                </div>
            </div>
            <img class="hero-image" src="{{ url_for('static', filename='images/patient-hero.svg') }}" alt="Patient dashboard illustration" />
        </section>

        <div class="dashboard-actions">
            <a class="action-btn" href="{{ url_for('results') }}">Hospitals</a>
            <a class="action-btn" href="{{ url_for('medicines') }}">Medicines</a>
            <a class="action-btn" href="{{ url_for('adaptive_assessment', user_id=user['id']) }}">Adaptive Assessment</a>
            <a class="action-btn" href="{{ url_for('emergency_profile', user_id=user['id']) }}">Emergency Profile</a>
            <a class="action-btn" href="{{ url_for('generate_qr_route', user_id=user['id']) }}">Generate QR</a>
            <a class="action-btn" href="{{ url_for('connect_doctor') }}">Connect Doctor</a>
            <a class="action-btn" href="{{ url_for('patient_logout') }}">Logout</a>
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>Adaptive Stress Score</h2>
                <p class="metric">{{ adaptive_state['stress_score'] }}</p>
            </div>
            <div class="card">
                <h2>Adaptive Energy Score</h2>
                <p class="metric">{{ adaptive_state['energy_score'] }}</p>
            </div>
        </div>

        <div class="card">
            <h2>Adaptive Trend and Risk</h2>
            <p><strong>Trend:</strong> {{ adaptive_state['trend'] | title }}</p>
            <p><strong>Risk Level:</strong> {{ adaptive_risk['risk'] }}</p>
            <p><strong>Risk Probability:</strong> {{ adaptive_risk['risk_probability'] if adaptive_risk['risk_probability'] is not none else 'N/A' }}%</p>
            <p><strong>Reason:</strong> {{ adaptive_risk['risk_reason'] or 'Calculated from current state and clinical rules.' }}</p>
            <p><strong>Recommendation:</strong> {{ adaptive_risk['recommendation'] or 'Continue regular monitoring and follow care plan.' }}</p>
        </div>

        <div class="card">
            <h2>Health Summary</h2>
            <p>{{ patient_health_summary }}</p>
        </div>

        <div class="card">
            <h2>Doctor Prescriptions</h2>
            {% for p in prescriptions %}
            <p><strong>Medicine:</strong> {{ p['medicine_name'] }}</p>
            <p><strong>Dosage:</strong> {{ p['dosage'] }} | <strong>Frequency:</strong> {{ p['frequency'] }}</p>
            <p><strong>Instructions:</strong> {{ p['instructions'] or 'N/A' }}</p>
            <p><strong>Start Date:</strong> {{ p['start_date'] }} | <strong>Prescribed By:</strong> {{ p['doctor_name'] or 'Doctor' }}</p>
            <hr />
            {% else %}
            <p>No doctor prescriptions yet.</p>
            {% endfor %}
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>Adherence Score</h2>
                <p class="metric">{{ adherence['percentage'] }}%</p>
                <p>{{ adherence['taken'] }} / {{ adherence['total'] }} doses taken</p>
            </div>

            <div class="card">
                <h2>Health Stability Score</h2>
                {% if health_summary %}
                <p class="metric">{{ health_summary['health_percentage'] }}%</p>
                <p>Status: <span class="{% if health_summary['status'] == 'Stable' %}ok{% elif health_summary['status'] == 'Moderate Risk' %}warn{% else %}risk{% endif %}">{{ health_summary['status'] }}</span></p>
                {% else %}
                <p>No health assessment submitted yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <h2>Hospital Recommendation Summary</h2>
            {% if top_recommendation %}
            <p><strong>Top Match:</strong> {{ top_recommendation['hospital_name'] }}</p>
            <p><strong>Score:</strong> {{ (top_recommendation['score'] * 100) | round(2) }}%</p>
            <pre class="explanation">{{ top_recommendation['explanation'] }}</pre>
            {% else %}
            <p>No recommendation available yet.</p>
            {% endif %}
        </div>

        <div class="grid-2">
            <div class="card">
                <h2>Medicine Stats</h2>
                {% for medicine in medicines %}
                <p>{{ medicine['name'] }}: {{ medicine['taken_count'] }}/{{ medicine['total_count'] }}</p>
                {% else %}
                <p>No medicines tracked.</p>
                {% endfor %}
            </div>

            <div class="card">
                <h2>Recent Health Logs</h2>
                {% for log in health_logs[:5] %}
                <p>{{ log['date'] }} | Sleep: {{ log['sleep_hours'] }}h | Stress: {{ log['stress_level'] }} | Energy: {{ log['energy_level'] }}</p>
                {% else %}
                <p>No health logs available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>
